version: '3.8'

services:
  # MySQL Database (Shared between both apps)
  db:
    image: mariadb:latest
    command: --lower_case_table_names=1
    container_name: jobboard-mysql
    restart: always
    ports:
      - '3306:3306'
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      MYSQL_DATABASE: jobboard_db
    volumes:
      - mysql_data_container:/var/lib/mysql
    networks:
      - jobboard-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # phpMyAdmin
  phpmyadmin:
    depends_on:
      db:
        condition: service_healthy
    image: phpmyadmin/phpmyadmin
    container_name: jobboard-phpmyadmin
    restart: always
    ports:
      - '8081:80'
    environment:
      PMA_HOST: db
      UPLOAD_LIMIT: 2000M
      MAX_EXECUTION_TIME: 3600
    networks:
      - jobboard-network

  # Job Backoffice Application
  backoffice:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: job-backoffice
    restart: always
    working_dir: /var/www
    volumes:
      - ./:/var/www
      - ./storage:/var/www/storage
      - ./bootstrap/cache:/var/www/bootstrap/cache
    ports:
      - '8000:8000'
      - '5173:5173'
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_CONNECTION: mariadb
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: jobboard_db
      DB_USERNAME: root
      DB_PASSWORD: ''
    networks:
      - jobboard-network
    command: bash -c "

        echo 'üîß Waiting for files to sync...'
        sleep 2
        
        echo 'üîß Fixing permissions...'
        chown -R www-data:www-data /var/www || true
        chmod -R 775 /var/www/storage /var/www/bootstrap/cache || true
        
        echo '‚è≥ Installing Composer dependencies...'
        composer install --no-interaction --prefer-dist --optimize-autoloader --no-cache
        
        echo '‚è≥ Installing NPM dependencies... (this may take 2-3 minutes)'
        npm ci --prefer-offline --no-audit
        
        echo '‚úÖ NPM install completed!'
        
        echo '‚è≥ Setting up environment...'
        [ ! -f .env ] && cp .env.example .env || true
        php artisan key:generate --force
        
        echo '‚è≥ Running migrations...'
        php artisan migrate --force
        
        echo '‚è≥ Seeding database...'
        php artisan db:seed --force
        
        echo '‚úÖ Database setup complete!'
        echo 'üöÄ Starting Laravel server...'
        php artisan serve --host=0.0.0.0 --port=8000 &
        
        echo '‚è≥ Waiting for Laravel to start...'
        sleep 5
        
        echo 'üé® Starting Vite dev server...'
        exec npm run dev -- --host
      "

volumes:
  mysql_data_container:

networks:
  jobboard-network:
    driver: bridge
    name: jobboard-network